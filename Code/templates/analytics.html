{% extends "base.html" %}

{% block title %}Analytics - Anemia Prediction System{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        padding: 40px 0;
    }

    .analytics-header {
        text-align: center;
        margin-bottom: 50px;
        animation: fadeInDown 0.6s ease-out;
    }

    .analytics-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        margin-bottom: 15px;
    }

    .analytics-subtitle {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
    }

    .plot-card {
        padding: 30px;
        margin-bottom: 30px;
        animation: fadeInUp 0.6s ease-out;
        animation-fill-mode: both;
        position: relative;
        overflow: hidden;
    }

    .plot-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        transition: left 0.5s;
    }

    .plot-card:hover::before {
        left: 100%;
    }

    .plot-card:nth-child(1) { animation-delay: 0.1s; }
    .plot-card:nth-child(2) { animation-delay: 0.2s; }
    .plot-card:nth-child(3) { animation-delay: 0.3s; }
    .plot-card:nth-child(4) { animation-delay: 0.4s; }

    .plot-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .plot-title i {
        color: #667eea;
    }

    .plot-image {
        width: 100%;
        height: auto;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .plot-image:hover {
        transform: scale(1.02);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .plot-description {
        margin-top: 15px;
        color: #666;
        line-height: 1.6;
        font-size: 0.95rem;
    }

    .no-plots {
        text-align: center;
        padding: 60px 20px;
        animation: fadeInUp 0.6s ease-out;
    }

    .no-plots-icon {
        font-size: 5rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 20px;
    }

    .no-plots-title {
        font-size: 2rem;
        font-weight: 600;
        color: white;
        margin-bottom: 15px;
    }

    .no-plots-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.1rem;
        margin-bottom: 30px;
    }

    .info-banner {
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 40px;
        animation: slideInDown 0.6s ease-out;
    }

    .info-banner h4 {
        color: #667eea;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .info-banner p {
        color: #666;
        margin: 0;
        line-height: 1.6;
    }

    .category-section {
        margin-bottom: 50px;
    }

    .category-title {
        font-size: 2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 30px;
        padding-left: 20px;
        border-left: 5px solid white;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    /* Modal styles for image zoom */
    .modal-content {
        background: rgba(0, 0, 0, 0.95);
        border: none;
    }

    .modal-body {
        padding: 0;
    }

    .modal-image {
        width: 100%;
        height: auto;
    }

    .download-btn {
        position: absolute;
        top: 20px;
        right: 60px;
        z-index: 1060;
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .download-btn:hover {
        background: #764ba2;
        transform: translateY(-2px);
    }

    .loading-spinner {
        text-align: center;
        padding: 100px 0;
        color: white;
    }

    .loading-spinner i {
        font-size: 4rem;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="analytics-header">
        <h1 class="analytics-title">
            <i class="fas fa-chart-bar"></i> Model Analytics
        </h1>
        <p class="analytics-subtitle">
            Comprehensive visualizations and performance metrics
        </p>
    </div>

    <div class="container">
        <div class="info-banner">
            <h4><i class="fas fa-lightbulb"></i> About These Analytics</h4>
            <p>
                These visualizations provide deep insights into our XGBoost model's performance and decision-making process. 
                The plots include data exploration, model evaluation metrics, and SHAP (SHapley Additive exPlanations) values 
                that explain which features most influence predictions. Understanding these analytics helps ensure transparency 
                and trustworthiness in AI-driven medical predictions.
            </p>
        </div>

        {% if plots %}
            <!-- Data Exploration Section -->
            <div class="category-section">
                <h2 class="category-title">
                    <i class="fas fa-database"></i> Data Exploration
                </h2>
                <div class="row">
                    {% for plot in plots[:3] %}
                    <div class="col-lg-6">
                        <div class="card plot-card">
                            <h3 class="plot-title">
                                <i class="fas fa-chart-pie"></i>
                                {{ plot.name }}
                            </h3>
                            <img src="{{ plot.path }}" alt="{{ plot.name }}" 
                                 class="plot-image" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal"
                                 onclick="showImage('{{ plot.path }}', '{{ plot.name }}')">
                            <p class="plot-description">
                                {% if 'target' in plot.name.lower() %}
                                    Shows the distribution of anemia cases in the training dataset. 
                                    A balanced dataset ensures unbiased model predictions.
                                {% elif 'feature' in plot.name.lower() %}
                                    Displays the distribution of each blood parameter feature. 
                                    Understanding feature distributions helps identify patterns and outliers.
                                {% elif 'correlation' in plot.name.lower() %}
                                    Illustrates relationships between different blood parameters. 
                                    Strong correlations can indicate redundant features or important relationships.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Model Performance Section -->
            <div class="category-section">
                <h2 class="category-title">
                    <i class="fas fa-tachometer-alt"></i> Model Performance
                </h2>
                <div class="row">
                    {% for plot in plots[3:5] %}
                    <div class="col-lg-6">
                        <div class="card plot-card">
                            <h3 class="plot-title">
                                <i class="fas fa-chart-line"></i>
                                {{ plot.name }}
                            </h3>
                            <img src="{{ plot.path }}" alt="{{ plot.name }}" 
                                 class="plot-image" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal"
                                 onclick="showImage('{{ plot.path }}', '{{ plot.name }}')">
                            <p class="plot-description">
                                {% if 'confusion' in plot.name.lower() %}
                                    Displays the model's prediction accuracy by showing true positives, 
                                    true negatives, false positives, and false negatives.
                                {% elif 'roc' in plot.name.lower() %}
                                    The ROC curve illustrates the model's diagnostic ability. 
                                    Higher area under curve (AUC) indicates better performance.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Model Explainability Section -->
            <div class="category-section">
                <h2 class="category-title">
                    <i class="fas fa-brain"></i> Model Explainability (SHAP)
                </h2>
                <div class="row">
                    {% for plot in plots[5:] %}
                    <div class="col-lg-6">
                        <div class="card plot-card">
                            <h3 class="plot-title">
                                <i class="fas fa-lightbulb"></i>
                                {{ plot.name }}
                            </h3>
                            <img src="{{ plot.path }}" alt="{{ plot.name }}" 
                                 class="plot-image" 
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageModal"
                                 onclick="showImage('{{ plot.path }}', '{{ plot.name }}')">
                            <p class="plot-description">
                                {% if 'summary' in plot.name.lower() and 'bar' not in plot.name.lower() %}
                                    SHAP summary plot shows how each feature impacts predictions. 
                                    Red indicates high feature values, blue indicates low values.
                                {% elif 'importance' in plot.name.lower() or 'bar' in plot.name.lower() %}
                                    Ranks features by their average impact on model predictions. 
                                    Features at the top have the most influence on anemia detection.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="no-plots">
                    <div class="no-plots-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h2 class="no-plots-title">No Analytics Available</h2>
                    <p class="no-plots-text">
                        Analytics plots haven't been generated yet. Please run the training script first.
                    </p>
                    <div class="alert alert-info d-inline-block">
                        <i class="fas fa-terminal"></i> Run: <code>python Train.py</code> to generate plots
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" 
                    data-bs-dismiss="modal" style="z-index: 1060;"></button>
            <a id="downloadBtn" class="download-btn" download>
                <i class="fas fa-download"></i> Download
            </a>
            <div class="modal-body">
                <img id="modalImage" src="" alt="" class="modal-image">
            </div>
        </div>
    </div>
</div>

<script>
    function showImage(imagePath, imageName) {
        document.getElementById('modalImage').src = imagePath;
        document.getElementById('modalImage').alt = imageName;
        document.getElementById('downloadBtn').href = imagePath;
        document.getElementById('downloadBtn').download = imageName + '.png';
    }

    // Add smooth scroll animation
    document.querySelectorAll('.plot-image').forEach(img => {
        img.addEventListener('click', function() {
            this.style.animation = 'none';
            setTimeout(() => {
                this.style.animation = '';
            }, 10);
        });
    });
</script>
{% endblock %}
